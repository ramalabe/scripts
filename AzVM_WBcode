# Author: R.A
# Runtime: Powershell 5.1

Param(
 [string]$VMname,
 [string]$RGname,
 [ValidateSet("Start", "Stop")]
 [string]$Action
)
 
# Login to Automation Account ( Connecting to the user-managed identity ) 
Write-Output "Connecting to azure via  Connect-AzAccount -Identity -AccountId <ClientId of USI>"  
Connect-AzAccount -Identity -AccountId <ClientId of USI> 
Write-Output "Successfully connected with Automation account's Managed Identity"  
 
# VM_Start
$VMs = $VMname.split(',')
foreach($VM in $VMs) {
IF ($Action -eq "Start") {
    Start-AzVM -Name $VM -ResourceGroupName $RGname | Out-Null
    Write-Output "Started the $VM Successfully"
    }
}

# VM_Stop
$VMs = $VMname.split(',')
foreach($VM in $VMs) {
IF ($Action -eq "Stop") {
    Stop-AzVM -Name $VM -ResourceGroupName $RGname -Force | Out-Null
    Write-Output "Stopped the $VM Successfully"
    }
}
